#!/usr/bin/env bash

# This script is a starting point to setup your application.
# Add necessary setup steps to this file.
echo -e "== Removing old docker images and volumes =="
docker-compose down --rmi local
docker rmi -f local/cocoitta 2>/dev/null || true
if [ -e docker/postgres/volume ]; then
  rm -rf docker/postgres/volume
fi

echo -e "\n== Removing old node_modules =="
if [ -e node_modules ]; then
  rm -rf node_modules
fi

echo -e "\n== Building docker images =="
docker-compose up --no-start

echo -e "\n== Preparing database =="
docker-compose start db
sleep 10
bin/yarn install
bin/rails db:setup

echo -e "\n== Removing old logs and tempfiles =="
bin/rails log:clear tmp:clear

echo -e "\n== Restarting application server =="
bin/rails s
